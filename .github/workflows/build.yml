name: Build Windows EXE

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas openpyxl pyinstaller
    
    - name: Build EXE
      run: |
        pyinstaller --onefile --console --hidden-import=multiprocessing --hidden-import=pandas --hidden-import=openpyxl --name="Excelæ•°æ®å¤„ç†å·¥å…·" excel.py
    
    - name: Upload EXE as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Excelæ•°æ®å¤„ç†å·¥å…·-Windows
        path: dist/
        if-no-files-found: error
    
    - name: Get current date
      id: date
      run: echo "date=$(Get-Date -Format 'yyyy.MM.dd-HH.mm')" >> $env:GITHUB_OUTPUT
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.date.outputs.date }}
        release_name: Excelæ•°æ®å¤„ç†å·¥å…· v${{ steps.date.outputs.date }}
        body: |
          ğŸ‰ Excelæ•°æ®å¤„ç†å·¥å…·è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
          
          ## ä½¿ç”¨æ–¹æ³•ï¼š
          1. ä¸‹è½½ä¸‹é¢çš„ `Excelæ•°æ®å¤„ç†å·¥å…·.exe` æ–‡ä»¶
          2. å°†ä»¥ä¸‹æ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•ï¼š
             - `é™„ä»¶ä¸€äº§å“ä¿¡æ¯åŠç¼–ç -å›ºå®šä¸å˜.xlsx`
             - `é™„ä»¶äºŒé”€å”®å‡ºåº“å¯¼å‡ºå±±å§†åŸå§‹è¡¨.xlsx`
          3. åŒå‡»è¿è¡Œexeæ–‡ä»¶
          
          ## åŠŸèƒ½ç‰¹ç‚¹ï¼š
          âœ… æ”¯æŒä¸€ä¸ªè®¢å•å¤šä¸ªå•†å“å¤„ç†
          âœ… æ™ºèƒ½å•†å“åç§°åŒ¹é…
          âœ… è‡ªåŠ¨ç”ŸæˆOMSä¸Šä¼ æ–‡ä»¶
          âœ… æ˜¾ç¤ºè¯¦ç»†å¤„ç†æ—¥å¿—
        draft: false
        prerelease: false
    
    - name: Upload Release Asset
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: dist/Excelæ•°æ®å¤„ç†å·¥å…·.exe
        asset_name: Excelæ•°æ®å¤„ç†å·¥å…·.exe
        asset_content_type: application/octet-stream 
